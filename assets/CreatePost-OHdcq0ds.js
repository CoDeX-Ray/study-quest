import{c as ee,u as te,b as se,E as ae,r as s,j as e,B as C,X as le,s as r}from"./index-BC4Bl_DL.js";import{I as f}from"./input-DxXjS8ON.js";import{L as i}from"./label-DW17_Th8.js";import{T as re}from"./textarea-NBqID4KY.js";import{C as ie}from"./card-BtsZ4tCb.js";import{S as B,a as X,b as D,c as O,d as c}from"./select-BDROE6Xq.js";import{A as oe,L as ne,c as ce,g as $}from"./LevelUpPopup-DjWU2rco.js";import{A as de}from"./arrow-left-B0aaM0S4.js";import"./index-Cihyj4XF.js";import"./chevron-down-BT1bYl59.js";import"./dialog-DkqcDn-U.js";import"./trophy-KGWIW8jd.js";import"./award-KPrSWlo0.js";const pe=ee("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Ne=()=>{const{user:a}=te(),N=se(),{toast:v}=ae(),[P,_]=s.useState(!1),[j,z]=s.useState(""),[u,R]=s.useState(""),[y,V]=s.useState(""),[b,Y]=s.useState("College"),[F,H]=s.useState(""),[d,K]=s.useState("material"),[p,E]=s.useState(null),[U,A]=s.useState(!1),[T,k]=s.useState(null),[L,I]=s.useState(null),W=t=>{const l=t.target.files?.[0];if(l){if(l.size>10*1024*1024){v({title:"Error",description:"File size must be less than 10MB",variant:"destructive"});return}E(l)}},G=()=>{E(null)},J=async t=>{if(t.preventDefault(),!a)return;_(!0);let l=0;d==="material"?l=50:d==="strategy"?l=30:d==="idea"&&(l=20);try{let m=null;if(p){A(!0);const h=p.name.split(".").pop(),o=`${a.id}/${Date.now()}.${h}`,{error:n}=await r.storage.from("post-files").upload(o,p);if(n)throw n;const{data:{publicUrl:x}}=r.storage.from("post-files").getPublicUrl(o);m=x,A(!1)}const{error:q}=await r.from("posts").insert({user_id:a.id,title:j,content:u,subject:y||null,category:b,department:F||null,post_type:d,file_url:m});if(q)throw q;await r.from("activity_logs").insert({user_id:a.id,action:"Posted content in Community",details:{post_title:j,post_type:d,category:b,subject:y||null,content_preview:u.substring(0,100)+(u.length>100?"...":"")}});const{data:w}=await r.from("profiles").select("xp, level").eq("id",a.id).single();if(w){const h=w.level,o=w.xp+l,n=Math.floor(o/100)+1,{error:x}=await r.from("profiles").update({xp:o,level:n}).eq("id",a.id);if(x)throw x;n>h&&(await r.from("activity_logs").insert({user_id:a.id,action:"Level Up / Rank Up",details:{old_level:h,new_level:n,xp_earned:l,total_xp:o}}),I({level:n}));const{count:Q}=await r.from("posts").select("*",{count:"exact",head:!0}).eq("user_id",a.id),S=await ce(a.id,o,Q||0);if(S.length>0){const M=await $(S[0]);M&&k(M);for(const Z of S){const g=await $(Z);g&&await r.from("activity_logs").insert({user_id:a.id,action:"Unlocked Achievement",details:{achievement_name:g.name,achievement_icon:g.icon,xp_required:g.xp_required}})}}}v({title:"Success!",description:`Post created! You earned ${l} XP.`}),setTimeout(()=>{N("/community")},2e3)}catch(m){v({title:"Error",description:m.message,variant:"destructive"})}finally{_(!1)}};return e.jsxs("div",{className:"container mx-auto p-4 md:p-8 max-w-3xl",children:[e.jsx(oe,{achievement:T,open:!!T,onOpenChange:t=>!t&&k(null)}),e.jsx(ne,{newLevel:L?.level||0,open:!!L,onOpenChange:t=>!t&&I(null)}),e.jsxs(C,{variant:"ghost",onClick:()=>N(-1),className:"mb-6",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Back"]}),e.jsxs(ie,{className:"p-6 md:p-8 bg-surface border-border/50",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Share Your Knowledge"}),e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"title",children:"Title"}),e.jsx(f,{id:"title",placeholder:"Enter a descriptive title",value:j,onChange:t=>z(t.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"category",children:"Category"}),e.jsx(f,{id:"category",value:b,onChange:t=>Y(t.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"department",children:"Department"}),e.jsxs(B,{value:F,onValueChange:H,children:[e.jsx(X,{children:e.jsx(D,{placeholder:"Select department"})}),e.jsxs(O,{children:[e.jsx(c,{value:"College of Engineering",children:"College of Engineering"}),e.jsx(c,{value:"College of Education",children:"College of Education"}),e.jsx(c,{value:"College of Arts and Science",children:"College of Arts and Science"}),e.jsx(c,{value:"College of Industrial Technology",children:"College of Industrial Technology"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"subject",children:"Subject (Optional)"}),e.jsx(f,{id:"subject",placeholder:"e.g., Mathematics, Science",value:y,onChange:t=>V(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"type",children:"Type"}),e.jsxs(B,{value:d,onValueChange:t=>K(t),children:[e.jsx(X,{children:e.jsx(D,{})}),e.jsxs(O,{children:[e.jsx(c,{value:"material",children:"Study Material (50 XP)"}),e.jsx(c,{value:"strategy",children:"Study Strategy (30 XP)"}),e.jsx(c,{value:"idea",children:"Idea (20 XP)"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"content",children:"Content"}),e.jsx(re,{id:"content",placeholder:"Share your knowledge, tips, or resources...",value:u,onChange:t=>R(t.target.value),rows:10,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"file",children:"Attach File (Optional)"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(f,{id:"file",type:"file",onChange:W,accept:"image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt",className:"hidden"}),e.jsxs(i,{htmlFor:"file",className:"flex items-center gap-2 px-4 py-2 border border-border rounded-md cursor-pointer hover:bg-accent transition-colors",children:[e.jsx(pe,{className:"w-4 h-4"}),p?"Change File":"Upload File"]}),p&&e.jsxs("div",{className:"flex items-center gap-2 flex-1 px-4 py-2 bg-surface border border-border rounded-md",children:[e.jsx("span",{className:"text-sm truncate flex-1",children:p.name}),e.jsx(C,{type:"button",variant:"ghost",size:"sm",onClick:G,className:"h-6 w-6 p-0",children:e.jsx(le,{className:"w-4 h-4"})})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Supported: Images, PDF, Word, PowerPoint, Excel, Text (Max 10MB)"})]}),e.jsx(C,{type:"submit",className:"w-full",disabled:P||U,children:P?"Posting...":U?"Uploading...":"Share Post"})]})]})]})};export{Ne as default};
