import{u as ce,a as de,b as me,r as d,h as m,E as ue,j as t,B as g,s as p}from"./index-Ded0JyBH.js";import{C as V}from"./card-DvR7wfGF.js";import{I as fe}from"./input-BajuTDme.js";import{l as pe,L as v,A as he}from"./communityFeed-D7o-fWD0.js";import{P as xe}from"./ProfilePopup-CNHIHbdR.js";import{M as ge}from"./megaphone-MSiEC8Ga.js";import{T as W}from"./trash-2-xBL8aNRD.js";import{T as ye,M as we,S as je}from"./thumbs-up-CDkc2H1S.js";import{S as _e}from"./share-2-D9dq2QKS.js";import"./dialog-DBPC4a0B.js";import"./XPBar-CniE5ETN.js";import"./profileStyles-BlV3Skav.js";import"./trophy-gnYbsPnn.js";import"./award-DFx4-MBN.js";const G=6,ve=()=>typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,Oe=()=>{const{user:a}=ce(),{isAdmin:w}=de(),H=me(),[u,h]=d.useState([]),[Y,S]=d.useState(!0),[C,P]=d.useState({}),[N,A]=d.useState({}),[Z,J]=d.useState({}),[b,L]=d.useState({}),[$,E]=d.useState({}),[K,D]=d.useState(null),[Q,T]=d.useState(!1),[j,U]=d.useState(null),[M,O]=d.useState({}),[q,z]=d.useState(null),[X,I]=d.useState(!0),[F,R]=d.useState(!1),k=d.useCallback(async({offset:e=0,replace:n=!1}={})=>{const r=e===0||n;r?S(!0):R(!0);try{const s=await pe({announcementsOnly:!0,from:e,limit:G});h(o=>{if(r)return s;const i=new Set(o.map(c=>c.id)),l=[...o];return s.forEach(c=>{i.has(c.id)||l.push(c)}),l}),I(s.length===G)}catch(s){console.error("Error fetching announcements:",s),m.error("Failed to load announcements")}finally{r?S(!1):R(!1)}},[]);d.useEffect(()=>{k({replace:!0})},[k]);const B=ue();d.useEffect(()=>{(()=>{try{const r=new URLSearchParams(B.search).get("post");r&&setTimeout(()=>{const s=document.getElementById(`post-${r}`);s&&s.scrollIntoView({behavior:"smooth",block:"center"})},150)}catch{}})()},[B,u]),d.useEffect(()=>{(async()=>{if(!a){U(null);return}const{data:n,error:r}=await p.from("profiles").select("id, full_name").eq("id",a.id).single();!r&&n&&U(n)})()},[a?.id]);const y=e=>{m.error(e),H("/auth")},ee=e=>{E(n=>({...n,[e]:!0})),!(typeof window>"u")&&window.setTimeout(()=>{E(n=>{const r={...n};return delete r[e],r})},600)},te=async e=>{if(!a){y("Please sign in to react to announcements");return}const n=u.find(o=>o.id===e);if(!n)return;const r=n.post_likes.some(o=>o.user_id===a.id),s=u;h(o=>o.map(i=>{if(i.id!==e)return i;const l=r?i.post_likes.filter(c=>c.user_id!==a.id):[...i.post_likes,{post_id:e,user_id:a.id}];return r||ee(e),{...i,post_likes:l}}));try{r?await p.from("post_likes").delete().eq("post_id",e).eq("user_id",a.id):(await p.from("post_likes").insert({post_id:e,user_id:a.id}),n.user_id!==a.id&&await p.from("notifications").insert({user_id:n.user_id,title:`${j?.full_name||"Someone"} liked your announcement`,message:`${n.title} received a new like.`,type:"announcement_like",related_post_id:n.id}))}catch(o){console.error("Error toggling like:",o),m.error("Unable to update reaction"),h(s)}},se=e=>{if(!a){y("Please sign in to join the discussion");return}J(n=>({...n,[e]:!n[e]}))},ie=async e=>{if(!a){y("Please sign in to comment");return}if(!u.find(s=>s.id===e))return;const r=(C[e]||"").trim();if(!r){m.error("Please enter a comment");return}A(s=>({...s,[e]:!0}));try{const s=u.find(l=>l.id===e);if(!s)return;const{data:o,error:i}=await p.from("post_comments").insert({post_id:e,user_id:a.id,content:r}).select("id, created_at").single();if(i)throw i;m.success("Comment added"),P(l=>({...l,[e]:""})),h(l=>l.map(c=>c.id===e?{...c,post_comments:[...c.post_comments,{id:o?.id||ve(),post_id:e,user_id:a.id,content:r,created_at:o?.created_at||new Date().toISOString(),author:j}]}:c)),s.user_id!==a.id&&await p.from("notifications").insert({user_id:s.user_id,title:`${j?.full_name||"Someone"} commented on your announcement`,message:r.length>80?`${r.slice(0,80)}...`:r,type:"announcement_comment",related_post_id:e})}catch(s){console.error("Error posting comment:",s),m.error("Unable to post comment")}finally{A(s=>({...s,[e]:!1}))}},re=async e=>{if(!a){y("Please sign in to share announcements");return}const n="/study-quest/",r=typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}${n}#/announcements?post=${e.id}`:`${n}#/announcements?post=${e.id}`;L(s=>({...s,[e.id]:!0}));try{typeof navigator<"u"&&navigator.share?(await navigator.share({title:e.title,text:e.content.slice(0,120),url:r}),m.success("Announcement shared")):navigator?.clipboard?.writeText?(await navigator.clipboard.writeText(r),m.success("Link copied to clipboard")):m.error("Sharing is not supported"),e.user_id!==a.id&&await p.from("notifications").insert({user_id:e.user_id,title:`${j?.full_name||"Someone"} shared your announcement`,message:`${e.title} was shared with others.`,type:"announcement_share",related_post_id:e.id});const s=async(i,l)=>{if(!a){y("Please sign in to delete comments");return}const c=u.find(f=>f.id===i),_=c?.post_comments.find(f=>f.id===l);if(!c||!_)return;if(_.user_id!==a.id&&c.user_id!==a.id&&!w){m.error("You can only delete your own comments");return}if(typeof window<"u"&&!window.confirm("Delete this comment?"))return;const oe=u;O(f=>({...f,[l]:!0})),h(f=>f.map(x=>x.id===i?{...x,post_comments:x.post_comments.filter(le=>le.id!==l)}:x));try{await p.from("post_comments").delete().eq("id",l),m.success("Comment deleted")}catch(f){console.error("Error deleting comment:",f),m.error("Unable to delete comment"),h(oe)}finally{O(f=>{const x={...f};return delete x[l],x})}},o=async i=>{if(!a||!w){m.error("Only admins can delete announcements");return}if(typeof window<"u"&&!window.confirm("Delete this announcement?"))return;const l=u;z(i),h(c=>c.filter(_=>_.id!==i));try{await p.from("posts").delete().eq("id",i),m.success("Announcement removed")}catch(c){console.error("Error deleting announcement:",c),m.error("Unable to delete announcement"),h(l)}finally{z(null)}}}catch(s){s?.name!=="AbortError"&&(console.error("Error sharing announcement:",s),m.error("Unable to share announcement"))}finally{L(s=>{const o={...s};return delete o[e.id],o})}},ae=e=>{e&&(D(e),T(!0))},ne=e=>{T(e),e||D(null)};return Y?t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsx("p",{className:"text-muted-foreground",children:"Loading announcements..."})}):t.jsxs("div",{className:"community-shell",children:[t.jsx("div",{className:"community-halo community-halo-one animate-gradient-slow"}),t.jsx("div",{className:"community-halo community-halo-two animate-gradient-slow"}),t.jsxs("div",{className:"relative z-10 container mx-auto px-3 sm:px-4 md:px-6 py-6 sm:py-8 md:py-10 max-w-5xl space-y-6 md:space-y-8",children:[t.jsx("section",{className:"community-panel rounded-3xl p-4 sm:p-6 md:p-10 shadow-glow",children:t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("p",{className:"text-xs uppercase tracking-[0.35em] text-primary/70 flex items-center gap-2",children:[t.jsx(ge,{className:"h-5 w-5"}),"Official Broadcasts"]}),t.jsx("h1",{className:"text-4xl md:text-5xl font-bold leading-tight",children:"Campus-Wide Announcements"}),t.jsx("p",{className:"text-muted-foreground max-w-3xl",children:"Stay in sync with every admin alert. React, ask questions, and keep the conversation flowing with your fellow learners."})]})}),t.jsxs("div",{className:"space-y-6",children:[u.map(e=>{const n=e.post_likes.length,r=e.post_comments.length,s=a&&e.post_likes.some(i=>i.user_id===a.id),o=Z[e.id];return t.jsxs(V,{id:`post-${e.id}`,className:"community-card relative overflow-hidden p-4 sm:p-6 md:p-8",children:[t.jsx("div",{className:"community-card-glow"}),t.jsxs("div",{className:"relative z-10 space-y-4",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.35em] text-primary/70",children:"Announcement"}),t.jsx("h2",{className:"text-2xl font-semibold",children:e.title}),t.jsx("button",{type:"button",onClick:()=>ae(e.user_id),className:"text-sm text-primary hover:text-primary/80 transition-colors",children:e.profiles?.full_name||"Admin"})]}),t.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.jsx("span",{children:new Date(e.created_at).toLocaleString()}),w&&t.jsx(g,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-destructive",onClick:()=>handleDeleteAnnouncement(e.id),disabled:q===e.id,"aria-label":"Delete announcement",children:q===e.id?t.jsx(v,{className:"h-4 w-4 animate-spin"}):t.jsx(W,{className:"h-4 w-4"})})]})]}),t.jsx("p",{className:"text-foreground/80 whitespace-pre-line leading-relaxed",children:e.content}),e.file_url&&t.jsx(he,{fileUrl:e.file_url,contextTitle:e.title,isAccessible:!!a,onRequestAccess:()=>y("Please sign in to view and download attachments")}),t.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[t.jsxs(g,{variant:"ghost",size:"sm",type:"button",className:`relative gap-2 rounded-full px-4 ${s?"text-primary":"text-muted-foreground"}`,onClick:()=>te(e.id),children:[t.jsx("span",{className:`like-spark ${$[e.id]?"opacity-100 like-spark-active":"opacity-0"}`,children:"+1"}),t.jsx(ye,{className:`h-4 w-4 ${s?"fill-primary":""} ${$[e.id]?"like-pop":""}`}),n]}),t.jsxs(g,{variant:"ghost",size:"sm",type:"button",className:`gap-2 rounded-full px-4 ${o?"text-primary":"text-muted-foreground"}`,onClick:()=>se(e.id),children:[t.jsx(we,{className:"h-4 w-4"}),r]}),t.jsxs(g,{variant:"ghost",size:"sm",type:"button",className:"gap-2 rounded-full px-4 text-muted-foreground hover:text-foreground",onClick:()=>re(e),disabled:b[e.id],children:[b[e.id]?t.jsx(v,{className:"h-4 w-4 animate-spin"}):t.jsx(_e,{className:"h-4 w-4"}),b[e.id]?"Sharing...":"Share"]})]}),o&&t.jsxs("div",{className:"community-comments space-y-4",children:[t.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto pr-1",children:e.post_comments.length===0?t.jsx("p",{className:"text-sm text-muted-foreground",children:"No comments yet. Start the conversation!"}):e.post_comments.map(i=>t.jsxs("div",{className:"rounded-2xl bg-surface/70 p-3 border border-white/5",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm font-semibold",children:[t.jsx("span",{children:i.author?.full_name||"Unknown"}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[t.jsx("span",{children:new Date(i.created_at).toLocaleString()}),(i.user_id===a?.id||e.user_id===a?.id||w)&&t.jsx(g,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-destructive",onClick:()=>handleDeleteComment(e.id,i.id),disabled:!!M[i.id],"aria-label":"Delete comment",children:M[i.id]?t.jsx(v,{className:"h-3.5 w-3.5 animate-spin"}):t.jsx(W,{className:"h-3.5 w-3.5"})})]})]}),t.jsx("p",{className:"text-sm text-foreground/80 mt-1",children:i.content})]},i.id))}),t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[t.jsx(fe,{placeholder:"Add your comment...",value:C[e.id]||"",onChange:i=>P(l=>({...l,[e.id]:i.target.value})),disabled:N[e.id],className:"bg-transparent border border-white/10 focus-visible:ring-primary/40"}),t.jsxs(g,{type:"button",onClick:()=>ie(e.id),disabled:N[e.id],className:"gap-2 shadow-glow",children:[t.jsx(je,{className:"h-4 w-4"}),N[e.id]?"Posting...":"Send"]})]})]})]})]},e.id)}),u.length===0&&t.jsxs(V,{className:"community-panel text-center py-12 space-y-2",children:[t.jsx("p",{className:"text-lg font-semibold",children:"No announcements yet"}),t.jsx("p",{className:"text-muted-foreground",children:"Check back later or enable notifications to stay updated."})]}),u.length>0&&X&&t.jsx("div",{className:"flex justify-center pt-4",children:t.jsx(g,{variant:"outline",className:"gap-2",onClick:()=>k({offset:u.length}),disabled:F,children:F?t.jsxs(t.Fragment,{children:[t.jsx(v,{className:"h-4 w-4 animate-spin"}),"Loading more..."]}):"Load more announcements"})})]})]}),t.jsx(xe,{userId:K,open:Q,onOpenChange:ne})]})};export{Oe as default};
