import{u as B,b as D,r,s as l,j as e,B as f,h as w}from"./index-BVjAQhW-.js";import{C as m}from"./card-CZ0wl70l.js";import{I as M}from"./input-BZt2eylR.js";import{T as z}from"./textarea-Cv8zfm5H.js";import{l as I,L as $,A as q}from"./communityFeed-Cq_g58Sa.js";import{M as _}from"./megaphone-DZQjyxII.js";import{U as H}from"./users-Aie1QkR2.js";import{A as O}from"./activity-CQsSXQ0_.js";import{S as G}from"./sparkles-CACa7akD.js";const se=()=>{const{user:h}=B(),C=D(),[i,y]=r.useState(""),[o,N]=r.useState(""),[v,k]=r.useState(!1),[S,E]=r.useState(null),[g,P]=r.useState([]),[b,R]=r.useState(!1),j=r.useCallback(async()=>{const{count:t,error:s}=await l.from("profiles").select("id",{count:"exact",head:!0}).in("role",["student","professional","admin"]);if(s){console.error("Error fetching audience count:",s);return}typeof t=="number"&&E(t)},[]),x=r.useCallback(async()=>{try{const t=await I({announcementsOnly:!0,limit:4});P(t.slice(0,4))}catch(t){console.error("Error loading recent announcements:",t)}},[]);r.useEffect(()=>{j(),x()},[j,x]);const L=async(t,s,a)=>{const{data:n,error:d}=await l.from("profiles").select("id").in("role",["student","professional"]);if(d||!n)throw d||new Error("Unable to load recipients");const u=n.map(c=>({user_id:c.id,title:`New Announcement: ${s}`,message:a.substring(0,140)+(a.length>140?"...":""),type:"announcement",related_post_id:t})),p=500;for(let c=0;c<u.length;c+=p){const W=u.slice(c,c+p),{error:A}=await l.from("notifications").insert(W);if(A)throw A}},T=async(t,s,a)=>{const{error:n}=await l.rpc("broadcast_announcement_notifications",{p_post_id:t,p_title:s,p_message:a});n&&(console.warn("RPC broadcast failed, falling back to client fan-out:",n),await L(t,s,a))},U=async t=>l.from("posts").insert({user_id:h?.id,title:i,content:o,subject:"General",post_type:t,category:"College",is_announcement:!0}).select().single(),F=async t=>{if(t.preventDefault(),!h||!i.trim()||!o.trim()){w.error("Please fill in all fields");return}k(!0);try{let s="announcement",a=null,n=null;const d=async()=>{const{data:u,error:p}=await U(s);n=u,a=p};if(await d(),a&&(a.message?.includes("post_type")||a.details?.includes("post_type")||a.message?.toLowerCase().includes("constraint")||a.code==="23514")&&(console.warn("Announcement post_type constraint triggered, falling back to 'idea' for compatibility."),s="idea",await d()),a||!n)throw a||new Error("Unable to create announcement");await T(n.id,i,o),await l.from("activity_logs").insert({user_id:h.id,action:"Created announcement",details:{title:i,post_id:n.id}}),w.success("Announcement posted successfully!"),y(""),N(""),x(),j()}catch(s){console.error("Error posting announcement:",s),w.error(typeof s?.message=="string"?`Failed to post announcement: ${s.message}`:"Failed to post announcement")}finally{k(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-surface/30 to-background",children:e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-5xl space-y-8",children:[e.jsxs("header",{className:"rounded-3xl p-6 sm:p-10 community-panel relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/20 via-accent/10 to-secondary/10 blur-3xl opacity-60"}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs uppercase tracking-[0.35em] text-primary/70 mb-4 flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5"}),"Broadcast Center"]}),e.jsx("h1",{className:"text-3xl md:text-4xl font-bold leading-tight",children:"Reach every learner with a single post"}),e.jsx("p",{className:"text-muted-foreground mt-3 max-w-2xl",children:"Craft important updates and we’ll deliver them to students, professionals, and admins—complete with notifications and community reactions."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 min-w-[220px]",children:[e.jsxs(m,{className:"p-4 bg-black/20 border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs uppercase tracking-[0.35em] text-muted-foreground mb-2",children:[e.jsx("span",{children:"Audience"}),e.jsx(H,{className:"h-4 w-4 text-primary"})]}),e.jsx("p",{className:"text-2xl font-semibold",children:S??"––"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Recipients"})]}),e.jsxs(m,{className:"p-4 bg-black/20 border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs uppercase tracking-[0.35em] text-muted-foreground mb-2",children:[e.jsx("span",{children:"Signal"}),e.jsx(O,{className:"h-4 w-4 text-accent"})]}),e.jsx("p",{className:"text-2xl font-semibold",children:g.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Recent posts"})]})]})]})]}),e.jsxs(m,{className:"p-6 sm:p-8 space-y-6",children:[e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Title"}),e.jsx(M,{value:i,onChange:t=>y(t.target.value),placeholder:"Midterm Week Schedule",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Preview Mode"}),e.jsx(f,{type:"button",variant:b?"default":"secondary",className:"w-full",onClick:()=>R(t=>!t),children:b?"Hide Preview":"Show Preview"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Content"}),e.jsx(z,{value:o,onChange:t=>N(t.target.value),placeholder:"Write your announcement...",rows:8,required:!0})]}),b&&e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-black/20 p-6 space-y-2",children:[e.jsxs("p",{className:"text-xs uppercase tracking-[0.3em] text-muted-foreground flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 text-primary"}),"Live Preview"]}),e.jsx("h3",{className:"text-2xl font-semibold",children:i||"Announcement Title"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[new Date().toLocaleString()," • Admin Broadcast"]}),e.jsx("p",{className:"text-foreground/80 whitespace-pre-wrap mt-3",children:o||"Write a message to preview it here..."})]}),e.jsx(f,{type:"submit",disabled:v,className:"w-full gap-2",children:v?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"h-4 w-4 animate-spin"}),"Dispatching..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-4 w-4"}),"Post Announcement"]})})]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"We’ll notify every admin, student, and professional instantly."})]}),e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Recent broadcasts"}),e.jsx(f,{variant:"ghost",size:"sm",onClick:x,children:"Refresh"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[g.length===0&&e.jsx(m,{className:"p-6 text-center text-muted-foreground",children:"No announcements yet"}),g.map(t=>e.jsxs(m,{className:"p-6 bg-gradient-to-br from-black/30 to-transparent border-border/40 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-primary/70 mb-1",children:"Announcement"}),e.jsx("h3",{className:"text-xl font-semibold",children:t.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(t.created_at).toLocaleString()})]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:t.profiles?.full_name||"Admin"})]}),e.jsx("p",{className:"text-sm text-foreground/80 line-clamp-4 whitespace-pre-wrap",children:t.content}),t.file_url&&e.jsx(q,{fileUrl:t.file_url,contextTitle:t.title,className:"border-white/5 bg-black/10"}),e.jsx(f,{variant:"ghost",size:"sm",className:"text-primary",onClick:()=>C(`/announcements#post-${t.id}`),children:"View announcement"})]},t.id))]})]})]})})};export{se as default};
