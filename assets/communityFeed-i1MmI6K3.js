import{c as b,j as t,B as f,s as d}from"./index-wmXKAJ3Q.js";const N=b("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]),v=r=>/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(r),k=({fileUrl:r,contextTitle:c,className:m,isAccessible:o=!0,onRequestAccess:p})=>{if(!r)return null;const i=decodeURIComponent(r.split("/").pop()||"attachment"),n=v(i),a=()=>{p?.()};return t.jsxs("div",{className:`rounded-2xl border border-white/10 bg-black/20 p-4 space-y-3 ${m||""} ${o?"":"relative overflow-hidden"}`,children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold",children:i}),t.jsx("p",{className:"text-xs text-muted-foreground",children:n?"Image attachment":"Downloadable resource"})]}),o?t.jsx(f,{variant:"secondary",size:"sm",asChild:!0,children:t.jsx("a",{href:r,target:"_blank",rel:"noopener noreferrer",download:!0,children:"Download"})}):t.jsx(f,{variant:"secondary",size:"sm",onClick:a,children:"Sign in to download"})]}),n&&t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:r,alt:`Attachment for ${c}`,className:`max-h-80 w-full rounded-xl object-cover border border-white/10 ${o?"":"blur-sm brightness-75 pointer-events-none select-none"}`,loading:"lazy"}),!o&&t.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center gap-2 text-center",children:[t.jsx("p",{className:"text-sm font-semibold text-white",children:"Sign in to preview this file"}),t.jsx(f,{variant:"secondary",size:"sm",onClick:a,children:"Sign in"})]})]})]})},y=10,C=async(r={})=>{const{announcementsOnly:c,excludeAnnouncements:m,from:o=0,limit:p=y}=r,i=o+Math.max(p,1)-1;let n=d.from("posts").select("id, title, content, subject, category, department, post_type, file_url, created_at, is_announcement, user_id").order("created_at",{ascending:!1}).range(o,i);c?n=n.eq("is_announcement",!0):m&&(n=n.eq("is_announcement",!1));const{data:a,error:h}=await n;if(h)throw h;if(!a||a.length===0)return[];const x=a.map(e=>e.id),[u,l]=await Promise.all([d.from("post_likes").select("post_id, user_id").in("post_id",x),d.from("post_comments").select("id, post_id, user_id, content, created_at").in("post_id",x).order("created_at",{ascending:!0})]);if(u.error)throw u.error;if(l.error)throw l.error;const j=(l.data||[]).map(e=>e.user_id),_=Array.from(new Set([...a.map(e=>e.user_id),...j]));let g=[];if(_.length){const{data:e,error:s}=await d.from("profiles").select("id, full_name").in("id",_);if(s)throw s;g=e||[]}const w=new Map(g.map(e=>[e.id,e]));return a.map(e=>({...e,profiles:w.get(e.user_id)||null,post_likes:(u.data||[]).filter(s=>s.post_id===e.id),post_comments:(l.data||[]).filter(s=>s.post_id===e.id).map(s=>({...s,author:w.get(s.user_id)||null}))}))};export{k as A,N as L,C as l};
