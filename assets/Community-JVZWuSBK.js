import{u as je,a as ve,b as Ne,r as c,E as be,h as m,j as t,L as ke,B as h,n as S,s as d}from"./index-Ded0JyBH.js";import{C as w}from"./card-DvR7wfGF.js";import{I as W}from"./input-BajuTDme.js";import{P as Pe}from"./ProfilePopup-CNHIHbdR.js";import{l as Se,L as _,A as Ce}from"./communityFeed-D7o-fWD0.js";import{S as Y}from"./sparkles-Dqc0lhXr.js";import{T as J,M as Z,S as Le}from"./thumbs-up-CDkc2H1S.js";import{U as $e}from"./users-HaIzMWUu.js";import{P as Ee}from"./plus-SLD-GR4Z.js";import{S as K}from"./share-2-D9dq2QKS.js";import{S as Ae}from"./search-B9B32OEk.js";import{T as X}from"./trash-2-xBL8aNRD.js";import"./dialog-DBPC4a0B.js";import"./XPBar-CniE5ETN.js";import"./profileStyles-BlV3Skav.js";import"./trophy-gnYbsPnn.js";import"./award-DFx4-MBN.js";const I=8,De=()=>typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,Ke=()=>{const{user:r}=je(),{isAdmin:g}=ve(),C=Ne(),[u,f]=c.useState([]),[j,ee]=c.useState(""),[te,L]=c.useState(!0),[y,$]=c.useState(null),[E,v]=c.useState({}),[N,A]=c.useState({}),[se,D]=c.useState({}),[ie,T]=c.useState(null),[re,U]=c.useState(!1),[q,z]=c.useState({}),[b,F]=c.useState({}),[M,B]=c.useState(null),[O,Q]=c.useState({}),[ne,ae]=c.useState(!0),[R,G]=c.useState(!1),V=be(),k=c.useCallback(async({offset:e=0,replace:s=!1}={})=>{const n=e===0||s;n?L(!0):G(!0);try{const i=await Se({from:e,limit:I,excludeAnnouncements:!0});f(o=>{if(n)return i;const a=new Set(o.map(p=>p.id)),l=[...o];return i.forEach(p=>{a.has(p.id)||l.push(p)}),l}),ae(i.length===I)}catch(i){console.error("Error fetching posts:",i),m.error("Failed to load posts")}finally{n?L(!1):G(!1)}},[]);c.useEffect(()=>{k({replace:!0})},[k,r?.id]),c.useEffect(()=>{(()=>{try{const n=new URLSearchParams(V.search).get("post");n&&setTimeout(()=>{const i=document.getElementById(`post-${n}`);i&&i.scrollIntoView({behavior:"smooth",block:"center"})},150)}catch{}})()},[V,u]),c.useEffect(()=>{(async()=>{if(!r){$(null),v({}),D({});return}const{data:s,error:n}=await d.from("profiles").select("id, full_name").eq("id",r.id).single();!n&&s&&$(s)})()},[r?.id]);const x=e=>{m.error(e),C("/auth")},oe=async e=>{if(!r){x("Please sign in to like posts");return}const s=u.find(o=>o.id===e);if(!s)return;const n=s.post_likes.some(o=>o.user_id===r.id),i=u;f(o=>o.map(a=>{if(a.id!==e)return a;const l=n?a.post_likes.filter(p=>p.user_id!==r.id):[...a.post_likes,{post_id:e,user_id:r.id}];return n||me(e),{...a,post_likes:l}}));try{n?(await d.from("post_likes").delete().eq("post_id",e).eq("user_id",r.id),await d.from("activity_logs").insert({user_id:r.id,action:"Unliked post",details:{post_id:e,post_title:s.title}})):(await d.from("post_likes").insert({post_id:e,user_id:r.id}),await d.from("activity_logs").insert({user_id:r.id,action:"Liked post",details:{post_id:e,post_title:s.title}}),s.user_id!==r.id&&await d.from("notifications").insert({user_id:s.user_id,title:`${y?.full_name||"Someone"} liked your post`,message:`${s.title} received a new like.`,type:"like",related_post_id:s.id}))}catch(o){console.error("Error toggling like:",o),m.error("Failed to update like"),f(i)}},le=e=>{if(!r){x("Please sign in to view and add comments");return}D(s=>({...s,[e]:!s[e]}))},ce=async e=>{if(!r){x("Please sign in to comment");return}const s=u.find(i=>i.id===e);if(!s)return;const n=(E[e]||"").trim();if(!n){m.error("Please enter a comment before posting");return}A(i=>({...i,[e]:!0}));try{const{data:i,error:o}=await d.from("post_comments").insert({post_id:e,user_id:r.id,content:n}).select("id, created_at").single();if(o)throw o;await d.from("activity_logs").insert({user_id:r.id,action:"Commented on post",details:{post_id:e,post_title:s.title}}),s.user_id!==r.id&&await d.from("notifications").insert({user_id:s.user_id,title:`${y?.full_name||"Someone"} commented on your post`,message:n.length>80?`${n.slice(0,80)}...`:n,type:"comment",related_post_id:s.id}),m.success("Comment posted"),v(a=>({...a,[e]:""})),f(a=>a.map(l=>l.id===e?{...l,post_comments:[...l.post_comments,{id:i?.id||De(),post_id:e,user_id:r.id,content:n,created_at:i?.created_at||new Date().toISOString(),author:y}]}:l))}catch(i){console.error("Error posting comment:",i),m.error("Failed to post comment")}finally{A(i=>({...i,[e]:!1}))}},de=async e=>{if(!r){x("Please sign in to share posts");return}const s="/study-quest/",n=typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}${s}#/community?post=${e.id}`:`${s}#/community?post=${e.id}`;F(i=>({...i,[e.id]:!0}));try{let i=null;if(typeof navigator<"u"&&navigator.share)await navigator.share({title:e.title,text:e.content.slice(0,120),url:n}),i="native";else if(typeof navigator<"u"&&navigator.clipboard?.writeText)await navigator.clipboard.writeText(n),i="copy";else{m.error("Sharing is not supported in this browser");return}await Promise.all([d.from("activity_logs").insert({user_id:r.id,action:"Shared post",details:{post_id:e.id,post_title:e.title,share_url:n}}),e.user_id!==r.id?d.from("notifications").insert({user_id:e.user_id,title:`${y?.full_name||"Someone"} shared your post`,message:`${e.title} was shared with others.`,type:"share",related_post_id:e.id}):Promise.resolve()]),i==="native"?m.success("Post shared successfully"):i==="copy"&&m.success("Post link copied to clipboard")}catch(i){if(i?.name==="AbortError")return;console.error("Error sharing post:",i),m.error("Unable to share post")}finally{F(i=>{const o={...i};return delete o[e.id],o})}},me=e=>{z(s=>({...s,[e]:!0})),!(typeof window>"u")&&window.setTimeout(()=>{z(s=>{const n={...s};return delete n[e],n})},600)},ue=e=>{e&&(T(e),U(!0))},he=e=>{U(e),e||T(null)},H=()=>{typeof document>"u"||document.getElementById("community-posts")?.scrollIntoView({behavior:"smooth",block:"start"})},fe=e=>{if(!e)return null;const s=e.split("/post-files/");return s.length<2?null:s[1]},pe=async e=>{if(!r){x("Please sign in to delete posts");return}const s=u.find(i=>i.id===e);if(!s)return;if(s.user_id!==r.id&&!g){m.error("You can only delete your own posts");return}if(typeof window<"u"&&!window.confirm("Delete this post? This cannot be undone."))return;const n=u;B(e),f(i=>i.filter(o=>o.id!==e));try{await Promise.all([d.from("post_comments").delete().eq("post_id",e),d.from("post_likes").delete().eq("post_id",e)]),await d.from("posts").delete().eq("id",e);const i=fe(s.file_url);i&&await d.storage.from("post-files").remove([i]).catch(()=>null),await d.from("activity_logs").insert({user_id:r.id,action:"Deleted post",details:{post_id:e,post_title:s.title}}),m.success("Post deleted")}catch(i){console.error("Error deleting post:",i),m.error("Unable to delete post"),f(n)}finally{B(null)}},xe=async(e,s)=>{if(!r){x("Please sign in to delete comments");return}const n=u.find(a=>a.id===e),i=n?.post_comments.find(a=>a.id===s);if(!n||!i)return;if(i.user_id!==r.id&&n.user_id!==r.id&&!g){m.error("You can only delete your own comments");return}if(typeof window<"u"&&!window.confirm("Delete this comment?"))return;const o=u;Q(a=>({...a,[s]:!0})),f(a=>a.map(l=>l.id===e?{...l,post_comments:l.post_comments.filter(p=>p.id!==s)}:l));try{await d.from("post_comments").delete().eq("id",s),await d.from("activity_logs").insert({user_id:r.id,action:"Deleted comment",details:{post_id:e,comment_id:s}}),m.success("Comment deleted")}catch(a){console.error("Error deleting comment:",a),m.error("Unable to delete comment"),f(o)}finally{Q(a=>{const l={...a};return delete l[s],l})}},ge=u.reduce((e,s)=>e+s.post_likes.length,0),ye=u.reduce((e,s)=>e+s.post_comments.length,0),we=new Set(u.map(e=>e.user_id)).size,_e=[{label:"Active posts",value:u.length,description:"Fresh study drops",Icon:Y},{label:"Appreciations",value:ge,description:"Likes sent",Icon:J},{label:"Contributors",value:we,description:"Learners sharing",Icon:$e},{label:"Discussions",value:ye,description:"Ideas exchanged",Icon:Z}],P=u.filter(e=>{const s=j.toLowerCase();return e.title.toLowerCase().includes(s)||e.content.toLowerCase().includes(s)||(e.subject||"").toLowerCase().includes(s)});return te?t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsx("p",{className:"text-muted-foreground",children:"Loading posts..."})}):t.jsxs("div",{className:"community-shell",children:[t.jsx("div",{className:"community-halo community-halo-one animate-gradient-slow"}),t.jsx("div",{className:"community-halo community-halo-two animate-gradient-slow"}),t.jsxs("div",{className:"relative z-10 container mx-auto px-3 sm:px-4 md:px-6 py-6 sm:py-8 md:py-10 max-w-5xl space-y-6 md:space-y-8",children:[t.jsx("section",{className:"community-panel rounded-3xl p-4 sm:p-6 md:p-10 shadow-glow",children:t.jsxs("div",{className:"grid gap-10 lg:grid-cols-[1.1fr_0.9fr]",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.35em] text-primary/70 mb-3",children:"Share & Inspire"}),t.jsx("h1",{className:"text-3xl sm:text-4xl md:text-5xl font-bold leading-tight mb-3 md:mb-4",children:"Community Hub"}),t.jsx("p",{className:"text-muted-foreground max-w-2xl",children:"Trade notes, celebrate wins, and keep your study streak alive with fellow Questers."}),t.jsxs("div",{className:"flex flex-wrap gap-3 mt-6",children:[r&&!g?t.jsx(ke,{to:"/create-post",children:t.jsxs(h,{className:"gap-2 shadow-glow",children:[t.jsx(Ee,{className:"h-4 w-4"}),"Share Material"]})}):t.jsxs(h,{className:"gap-2 shadow-glow",onClick:()=>{if(!r){C("/auth");return}H()},children:[t.jsx(Y,{className:"h-4 w-4"}),r?"Browse Community":"Join StudyQuest"]}),t.jsxs(h,{variant:"ghost",type:"button",className:"gap-2 text-muted-foreground hover:text-foreground",onClick:H,children:[t.jsx(K,{className:"h-4 w-4"}),"Explore posts"]})]})]}),t.jsx("div",{className:"grid grid-cols-2 gap-3 md:gap-4",children:_e.map(({label:e,value:s,description:n,Icon:i})=>t.jsxs(w,{className:"community-stat-card p-3 md:p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("div",{className:"p-2 rounded-xl bg-primary/10 text-primary",children:t.jsx(i,{className:"h-4 w-4"})}),t.jsx("span",{className:"text-[0.6rem] uppercase tracking-[0.3em] text-muted-foreground",children:e})]}),t.jsx("p",{className:"text-3xl font-semibold",children:s}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:n})]},e))})]})}),t.jsxs(w,{className:"community-panel p-0 overflow-hidden",children:[t.jsx("div",{className:"h-1 bg-gradient-to-r from-primary via-accent to-secondary"}),t.jsx("div",{className:"p-3 sm:p-4 md:p-6",children:t.jsxs("div",{className:"relative",children:[t.jsx(Ae,{className:"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),t.jsx(W,{placeholder:"Search by subject, title, or content...",value:j,onChange:e=>ee(e.target.value),className:"pl-11 bg-transparent border border-white/10 focus-visible:ring-primary/40"})]})})]}),t.jsxs("div",{id:"community-posts",className:"space-y-6 pb-16",children:[P.map(e=>{const s=e.post_likes.length,n=e.post_comments.length,i=r&&e.post_likes.some(a=>a.user_id===r.id),o=se[e.id];return t.jsxs(w,{id:`post-${e.id}`,className:"community-card relative overflow-hidden p-4 sm:p-6 md:p-8 transition-all duration-500 hover:-translate-y-1",children:[t.jsx("div",{className:"community-card-glow"}),t.jsxs("div",{className:"relative z-10 space-y-5",children:[e.is_announcement&&t.jsx("div",{className:"announcement-pill",children:"ðŸ“¢ Announcement"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground",children:[t.jsx(S,{variant:"outline",className:"community-chip",children:e.subject||"General"}),t.jsx(S,{variant:"outline",className:"community-chip",children:e.category||"General"}),e.department&&t.jsx(S,{variant:"outline",className:"community-chip",children:e.department})]}),t.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-start md:justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-2xl font-semibold leading-tight",children:e.title}),t.jsxs("button",{type:"button",onClick:()=>ue(e.user_id),className:"text-sm text-primary hover:text-primary/80 transition-colors",children:["Posted by ",e.profiles?.full_name||"Unknown"]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.jsx("span",{children:new Date(e.created_at).toLocaleString()}),(r?.id===e.user_id||g)&&t.jsx(h,{variant:"ghost",size:"icon",type:"button",className:"text-muted-foreground hover:text-destructive",onClick:()=>pe(e.id),disabled:M===e.id,"aria-label":"Delete post",children:M===e.id?t.jsx(_,{className:"h-4 w-4 animate-spin"}):t.jsx(X,{className:"h-4 w-4"})})]})]}),t.jsx("p",{className:"text-foreground/80 leading-relaxed whitespace-pre-line",children:e.content}),e.file_url&&t.jsx(Ce,{fileUrl:e.file_url,contextTitle:e.title,isAccessible:!!r,onRequestAccess:()=>x("Please sign in to view and download attachments")}),t.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[t.jsxs(h,{variant:"ghost",size:"sm",type:"button",className:`relative gap-2 rounded-full px-4 ${i?"text-primary":"text-muted-foreground"}`,onClick:()=>oe(e.id),children:[t.jsx("span",{className:`like-spark ${q[e.id]?"opacity-100 like-spark-active":"opacity-0"}`,children:"+1"}),t.jsx(J,{className:`h-4 w-4 transition-transform ${i?"fill-primary":""} ${q[e.id]?"like-pop":""}`}),s]}),t.jsxs(h,{variant:"ghost",size:"sm",type:"button",className:`gap-2 rounded-full px-4 ${o?"text-primary":"text-muted-foreground"}`,onClick:()=>le(e.id),children:[t.jsx(Z,{className:"h-4 w-4"}),n]}),t.jsxs(h,{variant:"ghost",size:"sm",type:"button",className:"gap-2 rounded-full px-4 text-muted-foreground hover:text-foreground",onClick:()=>de(e),disabled:b[e.id],children:[b[e.id]?t.jsx(_,{className:"h-4 w-4 animate-spin"}):t.jsx(K,{className:"h-4 w-4"}),b[e.id]?"Sharing...":"Share"]})]}),o&&t.jsxs("div",{className:"community-comments space-y-4",children:[t.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto pr-1",children:e.post_comments.length===0?t.jsx("p",{className:"text-sm text-muted-foreground",children:"No comments yet. Start the conversation!"}):e.post_comments.map(a=>t.jsxs("div",{className:"rounded-2xl bg-surface/70 p-3 border border-white/5",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm font-semibold",children:[t.jsx("span",{children:a.author?.full_name||"Unknown"}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[t.jsx("span",{children:new Date(a.created_at).toLocaleString()}),(a.user_id===r?.id||e.user_id===r?.id||g)&&t.jsx(h,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-destructive",onClick:()=>xe(e.id,a.id),disabled:!!O[a.id],"aria-label":"Delete comment",children:O[a.id]?t.jsx(_,{className:"h-3.5 w-3.5 animate-spin"}):t.jsx(X,{className:"h-3.5 w-3.5"})})]})]}),t.jsx("p",{className:"text-sm text-foreground/80 mt-1",children:a.content})]},a.id))}),t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[t.jsx(W,{placeholder:"Add your comment...",value:E[e.id]||"",onChange:a=>v(l=>({...l,[e.id]:a.target.value})),disabled:N[e.id],className:"bg-transparent border border-white/10 focus-visible:ring-primary/40"}),t.jsxs(h,{type:"button",onClick:()=>ce(e.id),disabled:N[e.id],className:"gap-2 shadow-glow",children:[t.jsx(Le,{className:"h-4 w-4"}),N[e.id]?"Posting...":"Send"]})]})]})]})]},e.id)}),P.length===0&&t.jsxs(w,{className:"community-panel text-center py-12 space-y-2",children:[t.jsx("p",{className:"text-lg font-semibold",children:"No posts found"}),t.jsx("p",{className:"text-muted-foreground",children:"Try adjusting your search terms."})]}),P.length>0&&ne&&j.trim()===""&&t.jsx("div",{className:"flex justify-center pt-4",children:t.jsx(h,{variant:"outline",className:"gap-2",onClick:()=>k({offset:u.length}),disabled:R,children:R?t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"h-4 w-4 animate-spin"}),"Loading more..."]}):"Load more posts"})})]})]}),t.jsx(Pe,{userId:ie,open:re,onOpenChange:he})]})};export{Ke as default};
